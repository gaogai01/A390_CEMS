<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°–å±±ç™¼é›»å»  CEMS ç›£æ§ç³»çµ±</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <style>
        /* ================= é›»è…¦ç‰ˆæ¨£å¼ (é è¨­å®Œæ•´é¡¯ç¤º) ================= */
        body { background-color: #121212; color: #ffffff; font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 20px; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { margin: 0; color: #448AFF; font-size: 28px; }
        .sub-title { color: #888; font-size: 14px; margin-top: 5px; }

        #debug-box { display: none; background: #b71c1c; color: #fff; padding: 15px; margin-bottom: 20px; border-radius: 8px; font-family: monospace; border: 1px solid #ff5252;}

        /* å…¨å» æ‘˜è¦é¢æ¿ */
        .summary-panel {
            display: flex; justify-content: center; gap: 0; 
            max-width: 1400px; margin: 0 auto 25px auto;
            background: #1E1E1E; border-radius: 12px; border: 1px solid #448AFF;
            box-shadow: 0 0 15px rgba(68, 138, 255, 0.15);
            overflow: hidden; flex-wrap: wrap;
        }
        .summary-item { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            flex: 1; min-width: 110px; border-right: 1px solid #333; padding: 15px 5px; 
        }
        .summary-item:last-child { border-right: none; }
        
        .sum-label { font-size: 13px; color: #aaa; margin-bottom: 8px; text-align: center; letter-spacing: 1px; white-space: nowrap;}
        .sum-value { font-size: 26px; font-weight: bold; font-family: 'Courier New', monospace; color: #fff; }
        .sum-unit { font-size: 12px; color: #666; margin-left: 3px;}
        
        .avg-val { color: #00E676; } 
        .boiler-val { color: #FF4081; }
        .weather-val { color: #FFAB40; } 
        .aqi-val { color: #00E5FF; }

        /* æ©Ÿçµ„åˆ—è¡¨ (Grid) */
        .grid-container {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* é›»è…¦ç‰ˆå¯¬åº¦å¯¬é¬† */
            gap: 15px; max-width: 1600px; margin: 0 auto 40px auto;
        }

        .card {
            background-color: #1E1E1E; border-radius: 12px; padding: 15px;
            border: 1px solid #333; box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            transition: background-color 0.3s; position: relative; border-top-width: 4px;
        }
        
        .phase-1 { border-top-color: #00E676; } 
        .phase-2 { border-top-color: #2979FF; } 
        .phase-label { font-size: 12px; margin-left: 8px; padding: 2px 6px; border-radius: 4px; font-weight: bold; vertical-align: middle; }
        .bg-phase-1 { background-color: #00E676; color: #000; } 
        .bg-phase-2 { background-color: #2979FF; color: #fff; } 

        .card-running { background-color: #0D3050 !important; border-left: 1px solid #2196F3; border-right: 1px solid #2196F3; border-bottom: 1px solid #2196F3; }

        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-bottom: 12px; }
        .unit-name { font-size: 22px; font-weight: bold; color: #fff; vertical-align: middle; }
        
        .state-tag { font-size: 12px; padding: 2px 8px; border-radius: 4px; background: #333; color: #888; font-weight: bold; margin-left: 5px;}
        .state-run { background: #2196F3; color: #fff; }
        .state-cal { background: #E040FB; color: #fff; }

        .status-light { width: 14px; height: 14px; border-radius: 50%; background-color: #444; border: 1px solid #000; }
        .status-ok { background-color: #00E676; box-shadow: 0 0 8px #00E676; } 
        .status-warn { background-color: #FFD700; box-shadow: 0 0 8px #FFD700; } 
        .status-danger { background-color: #FF5252; box-shadow: 0 0 8px #FF5252; } 

        .data-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px;}
        .label { color: #aaa; font-size: 15px; }
        .value { font-family: 'Courier New', monospace; font-size: 22px; font-weight: bold; }
        .unit { font-size: 12px; color: #bbb; margin-left: 3px; }

        .val-normal { color: #00E5FF; } 
        .val-warn { color: #FFD700; }    
        .val-danger { color: #FF5252; }  
        .val-info { color: #E0E0E0; } 

        /* åœ–è¡¨å€ */
        .chart-section { max-width: 1600px; margin: 0 auto; background: #1E1E1E; padding: 20px; border-radius: 12px; border: 1px solid #333; }
        .chart-controls { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; background: #252525; padding: 15px; border-radius: 8px; }
        select, input { background: #333; color: #fff; border: 1px solid #555; padding: 8px; border-radius: 6px; font-size: 16px; }
        button { background: #448AFF; color: white; border: none; padding: 8px 20px; border-radius: 6px; font-size: 16px; cursor: pointer; }
        button:hover { background: #2962FF; }
        
        #msg-box { text-align: center; color: #FFAB40; margin-top: 10px; min-height: 20px; font-size: 14px;}
        #footer-msg { text-align: center; color: #666; margin-top: 30px; font-size: 12px; }
        .legend { display: inline-block; margin: 0 5px; padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #000; font-weight: bold;}

        /* ================= æ‰‹æ©Ÿç‰ˆå°ˆç”¨å„ªåŒ– (å¯¬åº¦å°æ–¼ 768px) ================= */
        @media (max-width: 768px) {
            body { padding: 5px; }
            h1 { font-size: 22px; margin-bottom: 5px; }
            .sub-title { margin-bottom: 10px; }

            /* æ‘˜è¦é¢æ¿æ”¹ç‚º 3 æ¬„ */
            .summary-panel { 
                display: grid; grid-template-columns: repeat(3, 1fr); 
                padding: 5px; gap: 2px; background: transparent; border: none; box-shadow: none;
            }
            .summary-item { 
                border: 1px solid #333; background: #1E1E1E; 
                padding: 8px 2px; min-width: auto; border-radius: 6px;
            }
            .sum-label { font-size: 11px; margin-bottom: 2px; }
            .sum-value { font-size: 18px; }
            .sum-unit { font-size: 10px; }

            /* æ©Ÿçµ„åˆ—è¡¨å¼·åˆ¶é›™æ¬„ (ä¸€æ’å…©å€‹) */
            .grid-container {
                grid-template-columns: 1fr 1fr; 
                gap: 6px; margin-bottom: 20px;
            }

            /* å¡ç‰‡ç·Šæ¹ŠåŒ– */
            .card { padding: 8px 6px; border-radius: 6px; }
            .card-header { padding-bottom: 5px; margin-bottom: 5px; }
            .unit-name { font-size: 18px; }
            .phase-label { display: none; } /* æ‰‹æ©Ÿéš±è—æœŸåˆ¥æ–‡å­—ï¼Œæ”¹ç”¨é‚Šæ¡†è‰²è­˜åˆ¥ */
            .state-tag { font-size: 10px; padding: 1px 4px; }
            .status-light { width: 10px; height: 10px; }

            /* æ•¸æ“šåˆ—æ›´ç·Šæ¹Š */
            .data-row { margin-bottom: 2px; padding-bottom: 2px; border-bottom: 1px solid rgba(255,255,255,0.03); }
            .label { font-size: 12px; color: #999; }
            .value { font-size: 16px; }
            .unit { display: none; } /* æ‰‹æ©Ÿéš±è—å–®ä½ï¼Œç¯€çœç©ºé–“ */

            /* ğŸŒŸ é—œéµï¼šæ‰‹æ©Ÿç‰ˆéš±è—ä¸é€å…‰ç‡ */
            .opac-row { display: none !important; }

            /* åœ–è¡¨å€èª¿æ•´ */
            .chart-section { padding: 10px; }
            .chart-controls { flex-direction: column; gap: 5px; }
            select, input, button { width: 100%; box-sizing: border-box; }
            
            #footer-msg { font-size: 10px; }
        }
    </style>
</head>
<body>

    <header>
        <h1>å°–å±±ç™¼é›»å»  CEMS å…¨èƒ½ç›£æ§</h1>
        <div class="sub-title" id="last-update">ç³»çµ±å•Ÿå‹•ä¸­...</div>
    </header>

    <div id="debug-box"></div>

    <div class="summary-panel">
        <div class="summary-item"><span class="sum-label">é‹è½‰æ©Ÿçµ„</span><div><span class="sum-value" id="total-running">--</span><span class="sum-unit">éƒ¨</span></div></div>
        <div class="summary-item"><span class="sum-label">é‹è½‰é‹çˆ</span><div><span class="sum-value boiler-val" id="boiler-running">--</span><span class="sum-unit">åº§</span></div></div>
        <div class="summary-item"><span class="sum-label">NOx å¹³å‡</span><div><span class="sum-value avg-val" id="avg-nox">--</span><span class="sum-unit">ppm</span></div></div>
        <div class="summary-item"><span class="sum-label">SO2 å¹³å‡</span><div><span class="sum-value avg-val" id="avg-so2">--</span><span class="sum-unit">ppm</span></div></div>
        
        <div class="summary-item" style="border-left: 2px solid #448AFF;"><span class="sum-label">æ¾æ¹– AQI</span><div><span class="sum-value aqi-val" id="env-aqi">--</span><span class="sum-unit" id="env-status" style="font-size:14px; font-weight:bold; color:#aaa;"></span></div></div>
        <div class="summary-item"><span class="sum-label">æ¹–è¥¿é„‰ æ°£æº«</span><div><span class="sum-value weather-val" id="env-temp">--</span><span class="sum-unit">â„ƒ</span></div></div>
        <div class="summary-item"><span class="sum-label">ç’°å¢ƒé¢¨é€Ÿ</span><div><span class="sum-value weather-val" id="env-wind">--</span><span class="sum-unit">m/s</span></div></div>
        <div class="summary-item"><span class="sum-label">é¢¨å‘</span><div><span class="sum-value weather-val" id="env-dir">--</span><span class="sum-unit" style="font-size:16px"></span></div></div>
    </div>

    <div id="dashboard" class="grid-container">ä»‹é¢è¼‰å…¥ä¸­...</div>

    <div class="chart-section">
        <h3 style="margin-top:0; color:#448AFF;">ğŸ“ˆ æ­·å²è¶¨å‹¢æŸ¥è©¢</h3>
        <div class="chart-controls">
            <select id="sel-unit"></select>
            <select id="sel-item">
                <option value="SO2">äºŒæ°§åŒ–ç¡« (SO2)</option>
                <option value="NOX">æ°®æ°§åŒ–ç‰© (NOx)</option>
                <option value="TEMP">æº«åº¦ (Temp)</option>
                <option value="O2">æ°§æ°£ (O2)</option>
                <option value="FLOW">æ’æ”¾æµç‡ (Flow)</option>
                <option value="OPAC" style="color:#FFD700;">ä¸é€å…‰ç‡ (Opac)</option>
            </select>
            <input type="date" id="sel-date">
            <button onclick="queryHistory()">ğŸ” æŸ¥è©¢ç¹ªåœ–</button>
        </div>
        <div id="msg-box"></div>
        <div style="position: relative; height:400px; width:100%">
            <canvas id="historyChart"></canvas>
        </div>
    </div>
    
    <div id="footer-msg">
        è³‡æ–™ä¾†æºï¼šç’°å¢ƒéƒ¨ 15åˆ†(AQX_P_186) & 6åˆ†(AQX_P_185) | AQI | Open-Meteo<br>
        <span class="legend" style="background:#00E676; color:black;">ä¸€æœŸ</span> 1~4è™Ÿæ©Ÿ
        <span class="legend" style="background:#2979FF; color:white;">äºŒæœŸ</span> 5~12è™Ÿæ©Ÿ<br>
        <span class="legend" style="background:#FFD700;">é»ƒè‰²é è­¦</span> NOx>300 | SO2>120 | ä¸é€å…‰>8
        <span class="legend" style="background:#FF5252;">ç´…è‰²è¶…æ¨™</span> NOx>363 | SO2>133 | ä¸é€å…‰>40
    </div>

    <script>
        window.onerror = function(msg, url, line) {
            const box = document.getElementById('debug-box');
            box.style.display = 'block';
            box.innerText += `âš ï¸ éŒ¯èª¤: ${msg} (Line ${line})\n`;
            return false;
        };

        const API_KEY = '473ceb6e-8b72-4fc3-832e-183f324588ad';
        const CONTROL_ID = 'X0501232'; 
        const RULES = { NOX: { warn: 300, limit: 363 }, SO2: { warn: 120, limit: 133 }, OPAC: { warn: 8, limit: 40 } };
        const BOILER_UNITS = [1, 2, 3, 4, 5, 7, 9, 11];

        const polNoMap = {};
        const idToPolNo = {};
        for(let i=1; i<=12; i++) {
            let pCode = 'P' + String(i).padStart(3, '0');
            polNoMap[pCode] = i;
            idToPolNo[i] = pCode;
        }

        let globalUnits = {};
        for(let i=1; i<=12; i++) {
            globalUnits[i] = { nox: null, so2: null, o2: null, temp: null, flow: null, opac: null, isRunning: false, statusText: "åœæ©Ÿ", statusClass: "state-tag" };
        }

        function initDashboard() {
            const container = document.getElementById('dashboard');
            if(!container) return;
            let html = '';
            for (let i = 1; i <= 12; i++) {
                let phaseClass = (i <= 4) ? "phase-1" : "phase-2";
                let phaseLabelClass = (i <= 4) ? "bg-phase-1" : "bg-phase-2";
                let phaseText = (i <= 4) ? "ä¸€æœŸ" : "äºŒæœŸ";

                html += `
                    <div class="card ${phaseClass}" id="card-${i}">
                        <div class="card-header">
                            <div>
                                <span class="unit-name">#${i}</span>
                                <span class="phase-label ${phaseLabelClass}">${phaseText}</span>
                                <span class="state-tag" id="state-${i}">åœæ©Ÿ</span>
                            </div>
                            <div class="status-light" id="status-${i}"></div>
                        </div>
                        <div class="data-row"><span class="label">SO2</span><div class="value-group"><span class="value val-normal" id="so2-${i}">--</span><span class="unit">ppm</span></div></div>
                        <div class="data-row"><span class="label">NOx</span><div class="value-group"><span class="value val-normal" id="nox-${i}">--</span><span class="unit">ppm</span></div></div>
                        <div class="data-row"><span class="label">æº«åº¦</span><div class="value-group"><span class="value val-info" id="temp-${i}">--</span><span class="unit">â„ƒ</span></div></div>
                        <div class="data-row"><span class="label">æ°§æ°£</span><div class="value-group"><span class="value val-info" id="o2-${i}">--</span><span class="unit">%</span></div></div>
                        <div class="data-row"><span class="label">æµç‡</span><div class="value-group"><span class="value val-info" id="flow-${i}">--</span><span class="unit">CMH</span></div></div>
                        <div class="data-row opac-row"><span class="label">ä¸é€å…‰</span><div class="value-group"><span class="value val-normal" id="opac-${i}">--</span><span class="unit">%</span></div></div>
                    </div>`;
            }
            container.innerHTML = html;

            const selUnit = document.getElementById('sel-unit');
            if(selUnit) {
                selUnit.innerHTML = '';
                for (let i = 1; i <= 12; i++) {
                    let option = document.createElement('option');
                    option.value = i;
                    option.text = `æ©Ÿçµ„ #${i}`;
                    selUnit.appendChild(option);
                }
            }
            const dateEl = document.getElementById('sel-date');
            if(dateEl) dateEl.valueAsDate = new Date();
        }
        try { initDashboard(); } catch(e) { console.error(e); }

        // ===================== è³‡æ–™æŠ“å– =====================

        async function fetch15MinData() {
            const updateLabel = document.getElementById('last-update');
            updateLabel.innerText = "æ›´æ–°ä¸­...";
            const URL = `https://data.moenv.gov.tw/api/v2/aqx_p_186?api_key=${API_KEY}&limit=1000&sort=m_time desc&format=json&filters=cno,eq,${CONTROL_ID}`;
            
            try {
                const res = await fetch(URL);
                const data = await res.json();
                if (data.records && data.records.length > 0) {
                    processData(data.records, "15min");
                    const now = new Date();
                    updateLabel.innerText = `è³‡æ–™æ™‚é–“: ${data.records[0].m_time} (æ›´æ–°: ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')})`;
                    updateLabel.style.color = "#00E676";
                }
            } catch (e) { console.error("15min Error:", e); }
            
            fetch6MinOpacity();
        }

        async function fetch6MinOpacity() {
            // 6åˆ†é˜è³‡æ–™ä¾ç„¶è¦æŠ“ï¼Œåªæ˜¯æ‰‹æ©Ÿç‰ˆCSSæœƒéš±è—é¡¯ç¤ºï¼Œé›»è…¦ç‰ˆæœƒé¡¯ç¤º
            const cityEncoded = encodeURIComponent('æ¾æ¹–ç¸£');
            const URL = `https://data.moenv.gov.tw/api/v2/aqx_p_185?api_key=${API_KEY}&limit=1000&sort=m_time desc&format=json&filters=epb_county,eq,${cityEncoded}`;
            const PROXY_URL = `https://corsproxy.io/?${encodeURIComponent(URL)}`;

            try {
                const res = await fetch(PROXY_URL);
                const data = await res.json();
                if (data.records && data.records.length > 0) {
                    processData(data.records, "6min"); 
                }
            } catch (e) { 
                console.log("6min Proxy Error:", e);
                try {
                    const res2 = await fetch(URL);
                    const data2 = await res2.json();
                    if (data2.records && data2.records.length > 0) processData(data2.records, "6min");
                } catch(e2) {}
            }
        }

        function processData(records, source) {
            records.forEach(r => {
                if (source === "6min" && r.cno !== CONTROL_ID) return;

                let id = polNoMap[r.polno || r.PolNo];
                if (id) {
                    let name = r.itemdesc || ""; 
                    let val = parseFloat(r.m_value);
                    
                    if (source === "15min") {
                        let code = r.code2 || "";
                        if (code === "NA10") { globalUnits[id].isRunning = true; globalUnits[id].statusText = "é‹è½‰ä¸­"; globalUnits[id].statusClass = "state-tag state-run"; }
                        else if (code === "NA20") { globalUnits[id].isRunning = true; globalUnits[id].statusText = "é‹è½‰/æ ¡æ­£"; globalUnits[id].statusClass = "state-tag state-cal"; }
                        else if (code === "FA20") { globalUnits[id].isRunning = false; globalUnits[id].statusText = "åœæ©Ÿ/æ ¡æ­£"; globalUnits[id].statusClass = "state-tag state-cal"; }
                        else { globalUnits[id].isRunning = false; globalUnits[id].statusText = "åœæ©Ÿ"; globalUnits[id].statusClass = "state-tag"; }

                        if (name.includes("æ°®æ°§åŒ–ç‰©") || name.includes("NOx")) globalUnits[id].nox = val;
                        if (name.includes("äºŒæ°§åŒ–ç¡«") || name.includes("SO2")) globalUnits[id].so2 = val;
                        if (name.includes("æ°§æ°£") || name.includes("O2")) globalUnits[id].o2 = val;
                        if (name.includes("æº«åº¦") || name.includes("Temp")) globalUnits[id].temp = val;
                        if (name.includes("æµç‡") || name.includes("Flow")) globalUnits[id].flow = val;
                        if (name.includes("ä¸é€å…‰") || name.includes("Opac")) globalUnits[id].opac = val;
                    } 
                    else if (source === "6min") {
                        if (name.includes("ä¸é€å…‰") || name.includes("Opac")) globalUnits[id].opac = val;
                    }
                }
            });

            for(let i=1; i<=12; i++) updateCard(i, globalUnits[i]);
            updateAverage(globalUnits);
        }

        async function fetchEnvData() {
            try {
                const res = await fetch(`https://data.moenv.gov.tw/api/v2/aqx_p_432?api_key=${API_KEY}&limit=1000&format=json`);
                const data = await res.json();
                const penghu = data.records.find(r => r.sitename === 'é¦¬å…¬');
                if(penghu) {
                    document.getElementById('env-aqi').innerText = penghu.aqi;
                    const statusEl = document.getElementById('env-status');
                    statusEl.innerText = penghu.status;
                    const pollutant = penghu.pollutant || "";
                    if(pollutant) statusEl.innerText += ` (${pollutant})`;
                    
                    let aqi = parseInt(penghu.aqi);
                    let color = aqi<=50 ? "#00E676" : (aqi<=100 ? "#FFFF00" : (aqi<=150 ? "#FF9800" : (aqi<=200 ? "#FF5252" : "#9C27B0")));
                    document.getElementById('env-aqi').style.color = color;
                    statusEl.style.color = color;
                }
            } catch(e) { }

            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=23.58&longitude=119.67&current=temperature_2m,wind_speed_10m,wind_direction_10m&timezone=auto`);
                const data = await res.json();
                if(data.current) {
                    document.getElementById('env-temp').innerText = data.current.temperature_2m;
                    document.getElementById('env-wind').innerText = data.current.wind_speed_10m;
                    const deg = data.current.wind_direction_10m;
                    let dirStr = deg + "Â°";
                    if (deg >= 337.5 || deg < 22.5) dirStr = "åŒ—";
                    else if (deg >= 22.5 && deg < 67.5) dirStr = "æ±åŒ—";
                    else if (deg >= 67.5 && deg < 112.5) dirStr = "æ±";
                    else if (deg >= 112.5 && deg < 157.5) dirStr = "æ±å—";
                    else if (deg >= 157.5 && deg < 202.5) dirStr = "å—";
                    else if (deg >= 202.5 && deg < 247.5) dirStr = "è¥¿å—";
                    else if (deg >= 247.5 && deg < 292.5) dirStr = "è¥¿";
                    else if (deg >= 292.5 && deg < 337.5) dirStr = "è¥¿åŒ—";
                    document.getElementById('env-dir').innerText = dirStr;
                }
            } catch(e) { }
        }

        function updateAverage(units) {
            let runCount = 0;
            let boilerCount = 0;
            let sumNox = 0, cntNox = 0;
            let sumSo2 = 0, cntSo2 = 0;

            for(let i=1; i<=12; i++) {
                if (units[i].isRunning) {
                    runCount++;
                    if (BOILER_UNITS.includes(i)) boilerCount++; 
                    if (units[i].nox !== null) { sumNox += units[i].nox; cntNox++; }
                    if (units[i].so2 !== null) { sumSo2 += units[i].so2; cntSo2++; }
                }
            }

            document.getElementById('total-running').innerText = runCount;
            document.getElementById('boiler-running').innerText = boilerCount;
            document.getElementById('avg-nox').innerText = cntNox > 0 ? Math.round(sumNox / cntNox) : "--";
            document.getElementById('avg-so2').innerText = cntSo2 > 0 ? Math.round(sumSo2 / cntSo2) : "--";
        }

        function updateCard(id, data) {
            const card = document.getElementById(`card-${id}`);
            const state = document.getElementById(`state-${id}`);
            if(!card) return;

            if(data.isRunning) { card.classList.add("card-running"); }
            else { card.classList.remove("card-running"); }

            state.innerText = data.statusText;
            state.className = data.statusClass;

            updateVal('NOX', data.nox, `nox-${id}`);
            updateVal('SO2', data.so2, `so2-${id}`);
            updateVal('OPAC', data.opac, `opac-${id}`); 
            updateVal('NORMAL', data.o2, `o2-${id}`);
            updateVal('NORMAL', data.temp, `temp-${id}`);
            updateVal('NORMAL', data.flow, `flow-${id}`);

            const light = document.getElementById(`status-${id}`);
            let status = "ok";
            if ((data.nox > RULES.NOX.limit) || (data.so2 > RULES.SO2.limit) || (data.opac > RULES.OPAC.limit)) status = "danger";
            else if ((data.nox > RULES.NOX.warn) || (data.so2 > RULES.SO2.warn) || (data.opac > RULES.OPAC.warn)) status = "warn";
            
            if(data.isRunning || data.nox !== null) light.className = `status-light status-${status}`;
            else light.className = "status-light";
        }

        function updateVal(type, val, elId) {
            const el = document.getElementById(elId);
            if(val !== null) {
                if (val > 100) el.innerText = val.toFixed(0); 
                else el.innerText = val.toFixed(2);
                let cls = "value val-info";
                if (type !== 'NORMAL') {
                    cls = "value val-normal";
                    if(val > RULES[type].limit) cls = "value val-danger";
                    else if(val > RULES[type].warn) cls = "value val-warn";
                }
                el.className = cls;
            }
        }

        let myChart = null;
        async function queryHistory() {
            if (typeof Chart === 'undefined') { alert("åœ–è¡¨å…ƒä»¶è¼‰å…¥å¤±æ•—"); return; }
            const unitId = document.getElementById('sel-unit').value;
            const itemType = document.getElementById('sel-item').value;
            const dateStr = document.getElementById('sel-date').value;
            const msgBox = document.getElementById('msg-box');
            const btn = document.querySelector('button');

            if (!dateStr) { alert("è«‹é¸æ“‡æ—¥æœŸ"); return; }
            const polNo = idToPolNo[unitId]; 
            
            let URL = "";
            let useProxy = false;

            if (itemType === 'OPAC') {
                const cityEncoded = encodeURIComponent('æ¾æ¹–ç¸£');
                URL = `https://data.moenv.gov.tw/api/v2/aqx_p_185?api_key=${API_KEY}&limit=1000&format=json&filters=epb_county,eq,${cityEncoded}|polno,eq,${polNo}&sort=m_time desc`;
                useProxy = true;
            } else {
                URL = `https://data.moenv.gov.tw/api/v2/aqx_p_186?api_key=${API_KEY}&limit=1000&format=json&filters=cno,eq,${CONTROL_ID}|polno,eq,${polNo}&sort=m_time desc`;
            }

            try {
                btn.innerText = "ä¸‹è¼‰ä¸­..."; btn.disabled = true;
                msgBox.innerText = `æ­£åœ¨ä¸‹è¼‰è³‡æ–™...`;
                
                let res;
                if (useProxy) {
                    res = await fetch(`https://corsproxy.io/?${encodeURIComponent(URL)}`);
                } else {
                    res = await fetch(URL);
                }

                const data = await res.json();
                btn.innerText = "ğŸ” æŸ¥è©¢ç¹ªåœ–"; btn.disabled = false;
                if (data.records && data.records.length > 0) {
                    drawChart(data.records, itemType, unitId, dateStr);
                    msgBox.innerText = "";
                } else {
                    msgBox.innerText = `âš ï¸ æŸ¥ç„¡è³‡æ–™ã€‚`;
                    if(myChart) myChart.clear();
                }
            } catch (e) {
                btn.innerText = "ğŸ” æŸ¥è©¢ç¹ªåœ–"; btn.disabled = false;
                msgBox.innerText = "éŒ¯èª¤: " + e.message;
            }
        }

        function drawChart(records, itemType, unitId, dateLabel) {
            const chartData = [];
            const keywords = { 
                'NOX': ['æ°®æ°§åŒ–ç‰©', 'NOx'], 'SO2': ['äºŒæ°§åŒ–ç¡«', 'SO2'], 
                'O2': ['æ°§æ°£', 'O2'], 'TEMP': ['æº«åº¦', 'Temp'], 'FLOW': ['æµç‡', 'Flow'],
                'OPAC': ['ä¸é€å…‰', 'Opac'] 
            };

            records.forEach(r => {
                if (r.cno && r.cno !== CONTROL_ID) return;
                if (!r.m_time.startsWith(dateLabel)) return;
                let name = r.itemdesc || "";
                if (keywords[itemType].some(k => name.includes(k))) {
                    chartData.push({ x: r.m_time, y: parseFloat(r.m_value) });
                }
            });
            chartData.sort((a, b) => new Date(a.x) - new Date(b.x));

            if (chartData.length === 0) {
                document.getElementById('msg-box').innerText = `âš ï¸ è©²æ™‚æ®µç„¡ ${itemType} æ•¸æ“šã€‚`;
                if(myChart) myChart.clear(); return;
            }

            let color = '#E0E0E0'; 
            let labelName = itemType;
            let limitValue = null;
            if (itemType === 'NOX') { labelName = 'æ°®æ°§åŒ–ç‰© (ppm)'; color = '#00E5FF'; limitValue = RULES.NOX.limit; }
            else if (itemType === 'SO2') { labelName = 'äºŒæ°§åŒ–ç¡« (ppm)'; color = '#E040FB'; limitValue = RULES.SO2.limit; }
            else if (itemType === 'OPAC') { labelName = 'ä¸é€å…‰ç‡ (%)'; color = '#FFD700'; limitValue = RULES.OPAC.limit; }
            else if (itemType === 'O2') { labelName = 'æ°§æ°£ (%)'; color = '#B2FF59'; }
            else if (itemType === 'TEMP') { labelName = 'æº«åº¦ (â„ƒ)'; color = '#FF6E40'; }
            else if (itemType === 'FLOW') { labelName = 'æ’æ”¾æµç‡ (CMH)'; color = '#448AFF'; }

            const ctx = document.getElementById('historyChart').getContext('2d');
            if (myChart) myChart.destroy();

            const chartConfig = {
                type: 'line',
                data: {
                    datasets: [{ label: labelName, data: chartData, borderColor: color, backgroundColor: color + '33', borderWidth: 2, pointRadius: 3, fill: true, tension: 0.3 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { type: 'time', time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } }, grid: { color: '#333' }, ticks: { color: '#aaa' } }, y: { grid: { color: '#333' }, ticks: { color: '#aaa' }, beginAtZero: true } },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            };

            if (limitValue && typeof Chart.registry.plugins.get('annotation') !== 'undefined') {
                 chartConfig.options.plugins.annotation = { annotations: { line1: { type: 'line', yMin: limitValue, yMax: limitValue, borderColor: '#FF5252', borderWidth: 2, borderDash: [6, 6], label: { display: true, content: `ä¸Šé™: ${limitValue}`, color: '#FF5252', position: 'end' } } } };
            }
            myChart = new Chart(ctx, chartConfig);
        }

        fetch15MinData();     
        fetchEnvData();
        setInterval(fetch15MinData, 60000);
        setInterval(fetchEnvData, 300000);

    </script>
</body>
</html>
