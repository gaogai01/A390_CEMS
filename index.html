<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°–å±±ç™¼é›»å»  CEMS æ™ºèƒ½ç›£æ¸¬ (çµ‚æ¥µåœ–è¡¨ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>

    <style>
        body { background-color: #121212; color: #ffffff; font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 20px; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { margin: 0; color: #448AFF; font-size: 28px; }
        .sub-title { color: #888; font-size: 14px; margin-top: 5px; }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 15px;
            max-width: 1400px;
            margin: 0 auto 40px auto;
        }

        .card {
            background-color: #1E1E1E;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #333;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            transition: background-color 0.3s;
        }
        /* é‹è½‰ä¸­æ¨£å¼ */
        .card-running { background-color: #0D3050 !important; border: 1px solid #2196F3; }

        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-bottom: 12px;
        }

        .unit-name { font-size: 22px; font-weight: bold; color: #fff; }
        .state-tag { font-size: 12px; padding: 2px 8px; border-radius: 4px; background: #333; color: #888; font-weight: bold;}
        .state-run { background: #2196F3; color: #fff; }

        .status-light { width: 14px; height: 14px; border-radius: 50%; background-color: #444; border: 1px solid #000; }
        .status-ok { background-color: #00E676; box-shadow: 0 0 8px #00E676; } 
        .status-warn { background-color: #FFD700; box-shadow: 0 0 8px #FFD700; } 
        .status-danger { background-color: #FF5252; box-shadow: 0 0 8px #FF5252; } 

        .data-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px;}
        .label { color: #aaa; font-size: 15px; }
        .value { font-family: 'Courier New', monospace; font-size: 24px; font-weight: bold; }
        .unit { font-size: 12px; color: #bbb; margin-left: 3px; }

        .val-normal { color: #00E5FF; } 
        .val-warn { color: #FFD700; }    
        .val-danger { color: #FF5252; }  

        /* åœ–è¡¨å€ */
        .chart-section {
            max-width: 1400px; margin: 0 auto; background: #1E1E1E; padding: 20px; border-radius: 12px; border: 1px solid #333;
        }
        .chart-controls {
            display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; align-items: center;
            background: #252525; padding: 15px; border-radius: 8px;
        }
        select, input { background: #333; color: #fff; border: 1px solid #555; padding: 8px; border-radius: 6px; font-size: 16px; }
        button { background: #448AFF; color: white; border: none; padding: 8px 20px; border-radius: 6px; font-size: 16px; cursor: pointer; }
        button:hover { background: #2962FF; }
        
        #msg-box { text-align: center; color: #FFAB40; margin-top: 10px; min-height: 20px; font-size: 14px;}
        #footer-msg { text-align: center; color: #666; margin-top: 30px; font-size: 12px; }
        .legend { display: inline-block; margin: 0 5px; padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #000; font-weight: bold;}
    </style>
</head>
<body>

    <header>
        <h1>å°–å±±ç™¼é›»å»  CEMS æ™ºèƒ½ç›£æ¸¬</h1>
        <div class="sub-title" id="last-update">ç³»çµ±å•Ÿå‹•ä¸­...</div>
    </header>

    <div id="dashboard" class="grid-container"></div>

    <div class="chart-section">
        <h3 style="margin-top:0; color:#448AFF;">ğŸ“ˆ æ­·å²è¶¨å‹¢æŸ¥è©¢</h3>
        <div class="chart-controls">
            <select id="sel-unit"></select>
            <select id="sel-item">
                <option value="NOX">æ°®æ°§åŒ–ç‰© (NOx)</option>
                <option value="SO2">äºŒæ°§åŒ–ç¡« (SO2)</option>
                <option value="OPAC">ä¸é€å…‰ç‡ (Opac)</option>
            </select>
            <input type="date" id="sel-date">
            <button onclick="queryHistory()">ğŸ” æŸ¥è©¢ç¹ªåœ–</button>
        </div>
        <div id="msg-box"></div>
        <div style="position: relative; height:400px; width:100%">
            <canvas id="historyChart"></canvas>
        </div>
    </div>
    
    <div id="footer-msg">
        è³‡æ–™ä¾†æºï¼šç’°å¢ƒéƒ¨ 15åˆ†é˜æ•¸æ“š (AQX_P_186)<br>
        <span class="legend" style="background:#FFD700;">é»ƒè‰²é è­¦</span> NOx>300 | SO2>120 | ä¸é€å…‰>8
        <span class="legend" style="background:#FF5252;">ç´…è‰²è¶…æ¨™</span> NOx>363 | SO2>133 | ä¸é€å…‰>40<br>
        <span style="color:#2196F3; font-weight:bold;">è—è‰²èƒŒæ™¯</span> = é‹è½‰ä¸­
    </div>

    <script>
        const API_KEY = '473ceb6e-8b72-4fc3-832e-183f324588ad';
        const CONTROL_ID = 'X0501232'; 
        const RULES = {
            NOX: { warn: 300, limit: 363 }, 
            SO2: { warn: 120, limit: 133 }, 
            OPAC: { warn: 8, limit: 40 }    
        };

        const polNoMap = {};
        const idToPolNo = {};
        for(let i=1; i<=12; i++) {
            let pCode = 'P' + String(i).padStart(3, '0');
            polNoMap[pCode] = i;
            idToPolNo[i] = pCode;
        }

        // ===================== PART 1: å³æ™‚å„€è¡¨æ¿ =====================
        function initDashboard() {
            const container = document.getElementById('dashboard');
            let html = '';
            for (let i = 1; i <= 12; i++) {
                html += `
                    <div class="card" id="card-${i}">
                        <div class="card-header">
                            <div><span class="unit-name">#${i} æ©Ÿçµ„</span> <span class="state-tag" id="state-${i}">åœæ©Ÿ</span></div>
                            <div class="status-light" id="status-${i}"></div>
                        </div>
                        <div class="data-row"><span class="label">NOx</span><div><span class="value val-normal" id="nox-${i}">--</span><span class="unit">ppm</span></div></div>
                        <div class="data-row"><span class="label">SO2</span><div><span class="value val-normal" id="so2-${i}">--</span><span class="unit">ppm</span></div></div>
                        <div class="data-row"><span class="label">ä¸é€å…‰</span><div><span class="value val-normal" id="opac-${i}">--</span><span class="unit">%</span></div></div>
                    </div>`;
            }
            container.innerHTML = html;

            const selUnit = document.getElementById('sel-unit');
            for (let i = 1; i <= 12; i++) {
                let option = document.createElement('option');
                option.value = i;
                option.text = `æ©Ÿçµ„ #${i}`;
                selUnit.appendChild(option);
            }
            document.getElementById('sel-date').valueAsDate = new Date();
        }

        async function fetchRealtime() {
            const updateLabel = document.getElementById('last-update');
            const URL = `https://data.moenv.gov.tw/api/v2/aqx_p_186?api_key=${API_KEY}&limit=1000&sort=m_time desc&format=json&filters=cno,eq,${CONTROL_ID}`;
            try {
                const res = await fetch(URL);
                const data = await res.json();
                if (data.records && data.records.length > 0) {
                    processRealtimeData(data.records);
                    const now = new Date();
                    updateLabel.innerText = `è³‡æ–™æ™‚é–“: ${data.records[0].m_time} (æ›´æ–°: ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')})`;
                    updateLabel.style.color = "#00E676";
                }
            } catch (e) { console.error(e); updateLabel.innerText = "é€£ç·šå¤±æ•—"; updateLabel.style.color = "red"; }
        }

        function processRealtimeData(records) {
            let units = {};
            for(let i=1; i<=12; i++) units[i] = { nox: null, so2: null, opac: null, isRunning: false };

            records.forEach(r => {
                let id = polNoMap[r.polno || r.PolNo];
                if (id) {
                    let name = r.itemdesc || ""; 
                    let val = parseFloat(r.m_value);
                    if (r.code2 === "NA10") units[id].isRunning = true;

                    if (name.includes("æ°®æ°§åŒ–ç‰©") || name.includes("NOx")) { if(units[id].nox === null) units[id].nox = val; }
                    else if (name.includes("äºŒæ°§åŒ–ç¡«") || name.includes("SO2")) { if(units[id].so2 === null) units[id].so2 = val; }
                    else if (name.includes("ä¸é€å…‰") || name.includes("Opac")) { if(units[id].opac === null) units[id].opac = val; }
                }
            });
            for(let i=1; i<=12; i++) updateCard(i, units[i]);
        }

        function updateCard(id, data) {
            const card = document.getElementById(`card-${id}`);
            const state = document.getElementById(`state-${id}`);
            if(data.isRunning) { card.className = "card card-running"; state.innerText = "é‹è½‰ä¸­"; state.className="state-tag state-run"; }
            else { card.className = "card"; state.innerText = "åœæ©Ÿ"; state.className="state-tag"; }

            updateVal('NOX', data.nox, `nox-${id}`);
            updateVal('SO2', data.so2, `so2-${id}`);
            updateVal('OPAC', data.opac, `opac-${id}`);

            const light = document.getElementById(`status-${id}`);
            let status = "ok";
            if ((data.nox > RULES.NOX.limit) || (data.so2 > RULES.SO2.limit) || (data.opac > RULES.OPAC.limit)) status = "danger";
            else if ((data.nox > RULES.NOX.warn) || (data.so2 > RULES.SO2.warn) || (data.opac > RULES.OPAC.warn)) status = "warn";
            
            if(data.nox !== null || data.so2 !== null) light.className = `status-light status-${status}`;
            else light.className = "status-light";
        }

        function updateVal(type, val, elId) {
            const el = document.getElementById(elId);
            if(val !== null) {
                el.innerText = val.toFixed(2);
                let cls = "value val-normal";
                if(val > RULES[type].limit) cls = "value val-danger";
                else if(val > RULES[type].warn) cls = "value val-warn";
                el.className = cls;
            }
        }

        // ===================== PART 2: æ­·å²åœ–è¡¨ (é‚è¼¯é‡å¯«) =====================
        
        let myChart = null;

        async function queryHistory() {
            const unitId = document.getElementById('sel-unit').value;
            const itemType = document.getElementById('sel-item').value;
            const dateStr = document.getElementById('sel-date').value; // æ ¼å¼: 2025-11-23
            const msgBox = document.getElementById('msg-box');
            const btn = document.querySelector('button');

            if (!dateStr) { alert("è«‹é¸æ“‡æ—¥æœŸ"); return; }

            // å–å¾—å°æ‡‰çš„ P0xx ç·¨è™Ÿ
            const polNo = idToPolNo[unitId]; 

            // ğŸŒŸ é—œéµä¿®æ”¹ 1ï¼šä¸ç¯©é¸æ™‚é–“ï¼Œåªç¯©é¸æ©Ÿçµ„å’Œé›»å» 
            // æˆ‘å€‘ç›´æ¥æŠ“è©²æ©Ÿçµ„æœ€è¿‘ 1000 ç­†è³‡æ–™ (limit=1000 çµ•å°å¤ åŒ…å«è¿‘2å¤©)
            const URL = `https://data.moenv.gov.tw/api/v2/aqx_p_186?api_key=${API_KEY}&limit=1000&format=json&filters=cno,eq,${CONTROL_ID}|polno,eq,${polNo}&sort=m_time desc`;

            try {
                btn.innerText = "ä¸‹è¼‰ä¸­..."; btn.disabled = true;
                msgBox.innerText = `æ­£åœ¨ä¸‹è¼‰ æ©Ÿçµ„ #${unitId} çš„æ­·å²è³‡æ–™...`;

                const res = await fetch(URL);
                const data = await res.json();
                
                btn.innerText = "ğŸ” æŸ¥è©¢ç¹ªåœ–"; btn.disabled = false;

                if (data.records && data.records.length > 0) {
                    // ğŸŒŸ é—œéµä¿®æ”¹ 2ï¼šè³‡æ–™æŠ“å›ä¾†å¾Œï¼Œç”¨ JavaScript éæ¿¾æ—¥æœŸ
                    drawChart(data.records, itemType, unitId, dateStr);
                } else {
                    msgBox.innerText = `âš ï¸ æŸ¥ç„¡è³‡æ–™ã€‚è«‹ç¢ºèªæ©Ÿçµ„ #${unitId} æœ€è¿‘æ˜¯å¦æœ‰é‹è½‰ã€‚`;
                    if(myChart) myChart.clear();
                }
            } catch (e) {
                btn.innerText = "ğŸ” æŸ¥è©¢ç¹ªåœ–"; btn.disabled = false;
                msgBox.innerText = "éŒ¯èª¤: " + e.message;
            }
        }

        function drawChart(records, itemType, unitId, targetDate) {
            const chartData = [];
            
            const keywords = {
                'NOX': ['æ°®æ°§åŒ–ç‰©', 'NOx'],
                'SO2': ['äºŒæ°§åŒ–ç¡«', 'SO2'],
                'OPAC': ['ä¸é€å…‰', 'Opac']
            };

            // éæ¿¾è³‡æ–™ï¼šåªç•™é¸å®šæ—¥æœŸçš„æ•¸æ“š
            records.forEach(r => {
                // r.m_time æ ¼å¼é€šå¸¸æ˜¯ "2025-11-23 15:00:00"
                // æˆ‘å€‘æª¢æŸ¥å®ƒæ˜¯å¦ä»¥é¸å®šçš„æ—¥æœŸé–‹é ­
                if (!r.m_time.startsWith(targetDate)) return;

                let name = r.itemdesc || "";
                let match = keywords[itemType].some(k => name.includes(k));
                
                if (match) {
                    chartData.push({ x: r.m_time, y: parseFloat(r.m_value) });
                }
            });

            // æ’åºæ•¸æ“š (API é è¨­æ˜¯ descï¼Œç•«åœ–è¦ asc)
            chartData.sort((a, b) => new Date(a.x) - new Date(b.x));

            if (chartData.length === 0) {
                document.getElementById('msg-box').innerText = `âš ï¸ æ©Ÿçµ„ #${unitId} åœ¨ ${targetDate} æ²’æœ‰ ${itemType} çš„æ•¸æ“š (å¯èƒ½ç•¶å¤©åœæ©Ÿ)ã€‚`;
                if(myChart) myChart.clear();
                return;
            } else {
                document.getElementById('msg-box').innerText = `âœ… æˆåŠŸç¹ªè£½ï¼šæ©Ÿçµ„ #${unitId} - ${itemType} (${targetDate})`;
            }

            let color = '#00E5FF'; 
            let labelName = itemType;
            let limitValue = RULES[itemType].limit;

            if (itemType === 'NOX') { labelName = 'æ°®æ°§åŒ–ç‰© (ppm)'; color = '#00E5FF'; }
            if (itemType === 'SO2') { labelName = 'äºŒæ°§åŒ–ç¡« (ppm)'; color = '#E040FB'; }
            if (itemType === 'OPAC') { labelName = 'ä¸é€å…‰ç‡ (%)'; color = '#FFAB40'; }

            const ctx = document.getElementById('historyChart').getContext('2d');
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: labelName,
                        data: chartData,
                        borderColor: color,
                        backgroundColor: color + '33',
                        borderWidth: 2,
                        pointRadius: 3,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
                            grid: { color: '#333' }, ticks: { color: '#aaa' }
                        },
                        y: {
                            grid: { color: '#333' }, ticks: { color: '#aaa' }, beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#fff' } },
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: limitValue, yMax: limitValue,
                                    borderColor: '#FF5252', borderWidth: 2, borderDash: [6, 6],
                                    label: { display: true, content: `æ³•è¦ä¸Šé™: ${limitValue}`, color: '#FF5252', position: 'end', backgroundColor: 'rgba(0,0,0,0.7)' }
                                }
                            }
                        }
                    }
                }
            });
        }

        initDashboard();
        fetchRealtime();
        setInterval(fetchRealtime, 60000);

    </script>
</body>
</html>