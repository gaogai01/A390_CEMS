<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°–å±±ç™¼é›»å»  CEMS å…¨èƒ½ç›£æ§ (é˜²å½ˆç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <style>
        body { background-color: #121212; color: #ffffff; font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 20px; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { margin: 0; color: #448AFF; font-size: 28px; }
        .sub-title { color: #888; font-size: 14px; margin-top: 5px; }

        /* éŒ¯èª¤è¨Šæ¯å€ */
        #system-error { display: none; background: #b71c1c; color: #fff; padding: 15px; margin-bottom: 20px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; border: 1px solid #ff5252;}

        /* å…¨å» æ‘˜è¦é¢æ¿ */
        .summary-panel {
            display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;
            max-width: 1500px; margin: 0 auto 20px auto;
            background: #1E1E1E; padding: 15px; border-radius: 12px; border: 1px solid #448AFF;
            box-shadow: 0 0 10px rgba(68, 138, 255, 0.2);
        }
        .summary-item { display: flex; flex-direction: column; align-items: center; min-width: 120px; border-right: 1px solid #333; padding: 0 15px; }
        .summary-item:last-child { border-right: none; }
        .sum-label { font-size: 14px; color: #aaa; margin-bottom: 5px; }
        .sum-value { font-size: 28px; font-weight: bold; font-family: 'Courier New', monospace; color: #fff; }
        .sum-unit { font-size: 12px; color: #666; }
        .avg-val { color: #00E676; }

        /* Grid */
        .grid-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px; max-width: 1500px; margin: 0 auto 40px auto;
        }

        .card {
            background-color: #1E1E1E; border-radius: 12px; padding: 15px;
            border: 1px solid #333; box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            transition: background-color 0.3s;
        }
        .card-running { background-color: #0D3050 !important; border: 1px solid #2196F3; }

        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-bottom: 12px; }
        .unit-name { font-size: 22px; font-weight: bold; color: #fff; }
        .state-tag { font-size: 12px; padding: 2px 8px; border-radius: 4px; background: #333; color: #888; font-weight: bold;}
        .state-run { background: #2196F3; color: #fff; }

        .status-light { width: 14px; height: 14px; border-radius: 50%; background-color: #444; border: 1px solid #000; }
        .status-ok { background-color: #00E676; box-shadow: 0 0 8px #00E676; } 
        .status-warn { background-color: #FFD700; box-shadow: 0 0 8px #FFD700; } 
        .status-danger { background-color: #FF5252; box-shadow: 0 0 8px #FF5252; } 

        .data-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px;}
        .label { color: #aaa; font-size: 15px; }
        .value { font-family: 'Courier New', monospace; font-size: 22px; font-weight: bold; }
        .unit { font-size: 12px; color: #bbb; margin-left: 3px; }

        .val-normal { color: #00E5FF; } 
        .val-warn { color: #FFD700; }    
        .val-danger { color: #FF5252; }  
        .val-info { color: #E0E0E0; } 

        /* åœ–è¡¨å€ */
        .chart-section { max-width: 1500px; margin: 0 auto; background: #1E1E1E; padding: 20px; border-radius: 12px; border: 1px solid #333; }
        .chart-controls { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; background: #252525; padding: 15px; border-radius: 8px; }
        select, input { background: #333; color: #fff; border: 1px solid #555; padding: 8px; border-radius: 6px; font-size: 16px; }
        button { background: #448AFF; color: white; border: none; padding: 8px 20px; border-radius: 6px; font-size: 16px; cursor: pointer; }
        button:hover { background: #2962FF; }
        
        #msg-box { text-align: center; color: #FFAB40; margin-top: 10px; min-height: 20px; font-size: 14px;}
        #footer-msg { text-align: center; color: #666; margin-top: 30px; font-size: 12px; }
        .legend { display: inline-block; margin: 0 5px; padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #000; font-weight: bold;}
    </style>
</head>
<body>

    <div id="system-error"></div>

    <header>
        <h1>å°–å±±ç™¼é›»å»  CEMS å…¨èƒ½ç›£æ§</h1>
        <div class="sub-title" id="last-update">ç³»çµ±åˆå§‹åŒ–...</div>
    </header>

    <div class="summary-panel">
        <div class="summary-item">
            <span class="sum-label">é‹è½‰æ©Ÿçµ„</span>
            <div><span class="sum-value" id="total-running">--</span><span class="sum-unit">éƒ¨</span></div>
        </div>
        <div class="summary-item">
            <span class="sum-label">NOx å¹³å‡ (é‹è½‰ä¸­)</span>
            <div><span class="sum-value avg-val" id="avg-nox">--</span><span class="sum-unit">ppm</span></div>
        </div>
        <div class="summary-item">
            <span class="sum-label">SO2 å¹³å‡ (é‹è½‰ä¸­)</span>
            <div><span class="sum-value avg-val" id="avg-so2">--</span><span class="sum-unit">ppm</span></div>
        </div>
    </div>

    <div id="dashboard" class="grid-container">ä»‹é¢è¼‰å…¥ä¸­...</div>

    <div class="chart-section">
        <h3 style="margin-top:0; color:#448AFF;">ğŸ“ˆ æ­·å²è¶¨å‹¢æŸ¥è©¢</h3>
        <div class="chart-controls">
            <select id="sel-unit"></select>
            <select id="sel-item">
                <option value="NOX">æ°®æ°§åŒ–ç‰© (NOx)</option>
                <option value="SO2">äºŒæ°§åŒ–ç¡« (SO2)</option>
                <option value="O2">æ°§æ°£ (O2)</option>
                <option value="TEMP">æº«åº¦ (Temp)</option>
                <option value="FLOW">æ’æ”¾æµç‡ (Flow)</option>
            </select>
            <input type="date" id="sel-date">
            <button onclick="queryHistory()">ğŸ” æŸ¥è©¢ç¹ªåœ–</button>
        </div>
        <div id="msg-box"></div>
        <div style="position: relative; height:400px; width:100%">
            <canvas id="historyChart"></canvas>
        </div>
    </div>
    
    <div id="footer-msg">
        è³‡æ–™ä¾†æºï¼šç’°å¢ƒéƒ¨ 15åˆ†é˜æ•¸æ“š (AQX_P_186)<br>
        <span class="legend" style="background:#FFD700;">é»ƒè‰²é è­¦</span> NOx>300 | SO2>120 
        <span class="legend" style="background:#FF5252;">ç´…è‰²è¶…æ¨™</span> NOx>363 | SO2>133<br>
        <span style="color:#2196F3; font-weight:bold;">è—è‰²èƒŒæ™¯</span> = é‹è½‰ä¸­
    </div>

    <script>
        // --- å…¨åŸŸéŒ¯èª¤æ•æ‰ ---
        window.onerror = function(msg, url, line) {
            const errBox = document.getElementById('system-error');
            errBox.style.display = 'block';
            errBox.innerText += `âš ï¸ ç³»çµ±éŒ¯èª¤: ${msg} (è¡Œæ•¸: ${line})\n`;
            return false; 
        };

        // --- è®Šæ•¸è¨­å®š ---
        const API_KEY = '473ceb6e-8b72-4fc3-832e-183f324588ad';
        const CONTROL_ID = 'X0501232'; 
        const RULES = {
            NOX: { warn: 300, limit: 363 }, 
            SO2: { warn: 120, limit: 133 }
        };

        const polNoMap = {};
        const idToPolNo = {};
        for(let i=1; i<=12; i++) {
            let pCode = 'P' + String(i).padStart(3, '0');
            polNoMap[pCode] = i;
            idToPolNo[i] = pCode;
        }

        // ===================== PART 1: åˆå§‹åŒ– (ä¿è­‰åŸ·è¡Œ) =====================
        
        function initDashboard() {
            const container = document.getElementById('dashboard');
            if(!container) return;
            
            let html = '';
            for (let i = 1; i <= 12; i++) {
                html += `
                    <div class="card" id="card-${i}">
                        <div class="card-header">
                            <div><span class="unit-name">#${i} æ©Ÿçµ„</span> <span class="state-tag" id="state-${i}">åœæ©Ÿ</span></div>
                            <div class="status-light" id="status-${i}"></div>
                        </div>
                        <div class="data-row"><span class="label">NOx</span><div><span class="value val-normal" id="nox-${i}">--</span><span class="unit">ppm</span></div></div>
                        <div class="data-row"><span class="label">SO2</span><div><span class="value val-normal" id="so2-${i}">--</span><span class="unit">ppm</span></div></div>
                        <div class="data-row"><span class="label">æ°§æ°£</span><div><span class="value val-info" id="o2-${i}">--</span><span class="unit">%</span></div></div>
                        <div class="data-row"><span class="label">æº«åº¦</span><div><span class="value val-info" id="temp-${i}">--</span><span class="unit">â„ƒ</span></div></div>
                        <div class="data-row"><span class="label">æµç‡</span><div><span class="value val-info" id="flow-${i}">--</span><span class="unit">CMH</span></div></div>
                    </div>`;
            }
            container.innerHTML = html;

            // åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®
            const selUnit = document.getElementById('sel-unit');
            if(selUnit) {
                selUnit.innerHTML = '';
                for (let i = 1; i <= 12; i++) {
                    let option = document.createElement('option');
                    option.value = i;
                    option.text = `æ©Ÿçµ„ #${i}`;
                    selUnit.appendChild(option);
                }
            }
            
            const dateEl = document.getElementById('sel-date');
            if(dateEl) dateEl.valueAsDate = new Date();
        }

        // ç«‹å³åŸ·è¡Œåˆå§‹åŒ–ï¼Œç¢ºä¿ç•«é¢å…ˆå‡ºä¾†
        try {
            initDashboard();
        } catch(e) {
            console.error("Init failed", e);
        }

        // ===================== PART 2: å³æ™‚æ•¸æ“šèˆ‡å¹³å‡å€¼ =====================

        async function fetchRealtime() {
            const updateLabel = document.getElementById('last-update');
            updateLabel.innerText = "æ›´æ–°ä¸­...";
            const URL = `https://data.moenv.gov.tw/api/v2/aqx_p_186?api_key=${API_KEY}&limit=1000&sort=m_time desc&format=json&filters=cno,eq,${CONTROL_ID}`;
            
            try {
                const res = await fetch(URL);
                if(!res.ok) throw new Error(res.status);
                const data = await res.json();
                
                if (data.records && data.records.length > 0) {
                    processRealtimeData(data.records);
                    const now = new Date();
                    const t = data.records[0].m_time;
                    updateLabel.innerText = `è³‡æ–™æ™‚é–“: ${t} (æœ€å¾Œæª¢æŸ¥: ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')})`;
                    updateLabel.style.color = "#00E676";
                } else {
                    updateLabel.innerText = "é€£ç·šæˆåŠŸï¼Œä½†ç„¡è³‡æ–™ã€‚";
                    updateLabel.style.color = "#FFAB40";
                }
            } catch (e) { 
                console.error(e); 
                updateLabel.innerText = "é€£ç·šå¤±æ•—"; 
                updateLabel.style.color = "red";
                // é€™è£¡ä¸ä¸Ÿå‡ºéŒ¯èª¤ï¼Œä»¥å…å¡ä½
            }
        }

        function processRealtimeData(records) {
            let units = {};
            for(let i=1; i<=12; i++) units[i] = { nox: null, so2: null, o2: null, temp: null, flow: null, isRunning: false };

            records.forEach(r => {
                let id = polNoMap[r.polno || r.PolNo];
                if (id) {
                    let name = r.itemdesc || ""; 
                    let val = parseFloat(r.m_value);
                    
                    if (r.code2 === "NA10") units[id].isRunning = true;

                    if (name.includes("æ°®æ°§åŒ–ç‰©") || name.includes("NOx")) { if(units[id].nox === null) units[id].nox = val; }
                    else if (name.includes("äºŒæ°§åŒ–ç¡«") || name.includes("SO2")) { if(units[id].so2 === null) units[id].so2 = val; }
                    else if (name.includes("æ°§æ°£") || name.includes("O2")) { if(units[id].o2 === null) units[id].o2 = val; }
                    else if (name.includes("æº«åº¦") || name.includes("Temp")) { if(units[id].temp === null) units[id].temp = val; }
                    else if (name.includes("æµç‡") || name.includes("Flow")) { if(units[id].flow === null) units[id].flow = val; }
                }
            });

            // æ›´æ–°å¡ç‰‡
            for(let i=1; i<=12; i++) updateCard(i, units[i]);
            // æ›´æ–°å¹³å‡å€¼
            updateAverage(units);
        }

        // ğŸŒŸ æ–°å¢ï¼šå¹³å‡å€¼è¨ˆç®—
        function updateAverage(units) {
            let runCount = 0;
            let sumNox = 0, cntNox = 0;
            let sumSo2 = 0, cntSo2 = 0;

            for(let i=1; i<=12; i++) {
                if (units[i].isRunning) {
                    runCount++;
                    if (units[i].nox !== null) { sumNox += units[i].nox; cntNox++; }
                    if (units[i].so2 !== null) { sumSo2 += units[i].so2; cntSo2++; }
                }
            }

            document.getElementById('total-running').innerText = runCount;
            document.getElementById('avg-nox').innerText = cntNox > 0 ? Math.round(sumNox / cntNox) : "--";
            document.getElementById('avg-so2').innerText = cntSo2 > 0 ? Math.round(sumSo2 / cntSo2) : "--";
        }

        function updateCard(id, data) {
            const card = document.getElementById(`card-${id}`);
            const state = document.getElementById(`state-${id}`);
            if(!card) return;

            if(data.isRunning) { card.className = "card card-running"; state.innerText = "é‹è½‰ä¸­"; state.className="state-tag state-run"; }
            else { card.className = "card"; state.innerText = "åœæ©Ÿ"; state.className="state-tag"; }

            updateVal('NOX', data.nox, `nox-${id}`);
            updateVal('SO2', data.so2, `so2-${id}`);
            updateVal('NORMAL', data.o2, `o2-${id}`);
            updateVal('NORMAL', data.temp, `temp-${id}`);
            updateVal('NORMAL', data.flow, `flow-${id}`);

            const light = document.getElementById(`status-${id}`);
            let status = "ok";
            if ((data.nox > RULES.NOX.limit) || (data.so2 > RULES.SO2.limit)) status = "danger";
            else if ((data.nox > RULES.NOX.warn) || (data.so2 > RULES.SO2.warn)) status = "warn";
            
            if(data.nox !== null || data.so2 !== null) light.className = `status-light status-${status}`;
            else light.className = "status-light";
        }

        function updateVal(type, val, elId) {
            const el = document.getElementById(elId);
            if(val !== null) {
                if (val > 100) el.innerText = val.toFixed(0); 
                else el.innerText = val.toFixed(2);
                
                let cls = "value val-info";
                if (type !== 'NORMAL') {
                    cls = "value val-normal";
                    if(val > RULES[type].limit) cls = "value val-danger";
                    else if(val > RULES[type].warn) cls = "value val-warn";
                }
                el.className = cls;
            }
        }

        // ===================== PART 3: æ­·å²åœ–è¡¨ =====================
        let myChart = null;

        async function queryHistory() {
            // æª¢æŸ¥ Chart æ˜¯å¦å­˜åœ¨ (é˜²æ­¢æ²’ç¶²è·¯æ™‚ç•¶æ©Ÿ)
            if (typeof Chart === 'undefined') {
                alert("åœ–è¡¨å…ƒä»¶è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
                return;
            }

            const unitId = document.getElementById('sel-unit').value;
            const itemType = document.getElementById('sel-item').value;
            const dateStr = document.getElementById('sel-date').value;
            const msgBox = document.getElementById('msg-box');
            const btn = document.querySelector('button');

            if (!dateStr) { alert("è«‹é¸æ“‡æ—¥æœŸ"); return; }
            const polNo = idToPolNo[unitId]; 
            const URL = `https://data.moenv.gov.tw/api/v2/aqx_p_186?api_key=${API_KEY}&limit=1000&format=json&filters=cno,eq,${CONTROL_ID}|polno,eq,${polNo}&sort=m_time desc`;

            try {
                btn.innerText = "ä¸‹è¼‰ä¸­..."; btn.disabled = true;
                msgBox.innerText = `æ­£åœ¨ä¸‹è¼‰...`;
                const res = await fetch(URL);
                const data = await res.json();
                btn.innerText = "ğŸ” æŸ¥è©¢ç¹ªåœ–"; btn.disabled = false;
                if (data.records && data.records.length > 0) {
                    drawChart(data.records, itemType, unitId, dateStr);
                    msgBox.innerText = "";
                } else {
                    msgBox.innerText = `âš ï¸ æŸ¥ç„¡è³‡æ–™ã€‚`;
                    if(myChart) myChart.clear();
                }
            } catch (e) {
                btn.innerText = "ğŸ” æŸ¥è©¢ç¹ªåœ–"; btn.disabled = false;
                msgBox.innerText = "éŒ¯èª¤: " + e.message;
            }
        }

        function drawChart(records, itemType, unitId, dateLabel) {
            const chartData = [];
            const keywords = {
                'NOX': ['æ°®æ°§åŒ–ç‰©', 'NOx'],
                'SO2': ['äºŒæ°§åŒ–ç¡«', 'SO2'],
                'O2': ['æ°§æ°£', 'O2'],
                'TEMP': ['æº«åº¦', 'Temp'],
                'FLOW': ['æµç‡', 'Flow']
            };

            records.forEach(r => {
                if (!r.m_time.startsWith(dateLabel)) return;
                let name = r.itemdesc || "";
                if (keywords[itemType].some(k => name.includes(k))) {
                    chartData.push({ x: r.m_time, y: parseFloat(r.m_value) });
                }
            });
            chartData.sort((a, b) => new Date(a.x) - new Date(b.x));

            if (chartData.length === 0) {
                document.getElementById('msg-box').innerText = `âš ï¸ æ©Ÿçµ„ #${unitId} åœ¨ ${dateLabel} æ²’æœ‰ ${itemType} çš„æ•¸æ“šã€‚`;
                if(myChart) myChart.clear();
                return;
            }

            let color = '#E0E0E0'; 
            let labelName = itemType;
            let limitValue = null;
            if (itemType === 'NOX') { labelName = 'æ°®æ°§åŒ–ç‰© (ppm)'; color = '#00E5FF'; limitValue = RULES.NOX.limit; }
            else if (itemType === 'SO2') { labelName = 'äºŒæ°§åŒ–ç¡« (ppm)'; color = '#E040FB'; limitValue = RULES.SO2.limit; }
            else if (itemType === 'O2') { labelName = 'æ°§æ°£ (%)'; color = '#B2FF59'; }
            else if (itemType === 'TEMP') { labelName = 'æº«åº¦ (â„ƒ)'; color = '#FF6E40'; }
            else if (itemType === 'FLOW') { labelName = 'æ’æ”¾æµç‡ (CMH)'; color = '#448AFF'; }

            const ctx = document.getElementById('historyChart').getContext('2d');
            if (myChart) myChart.destroy();

            const chartConfig = {
                type: 'line',
                data: {
                    datasets: [{
                        label: labelName, data: chartData,
                        borderColor: color, backgroundColor: color + '33',
                        borderWidth: 2, pointRadius: 3, fill: true, tension: 0.3
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } }, grid: { color: '#333' }, ticks: { color: '#aaa' } },
                        y: { grid: { color: '#333' }, ticks: { color: '#aaa' }, beginAtZero: true }
                    },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            };

            // å®‰å…¨æª¢æŸ¥ï¼šç¢ºèª annotation æ’ä»¶æ˜¯å¦å­˜åœ¨
            if (limitValue && typeof Chart.registry.plugins.get('annotation') !== 'undefined') {
                 chartConfig.options.plugins.annotation = {
                    annotations: {
                        line1: { type: 'line', yMin: limitValue, yMax: limitValue, borderColor: '#FF5252', borderWidth: 2, borderDash: [6, 6], label: { display: true, content: `ä¸Šé™: ${limitValue}`, color: '#FF5252', position: 'end' } }
                    }
                };
            }
            myChart = new Chart(ctx, chartConfig);
        }

        // å•Ÿå‹• API æŠ“å–
        fetchRealtime();
        setInterval(fetchRealtime, 60000);

    </script>
</body>
</html>
